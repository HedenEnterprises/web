steps:
- id: build
  name: "gcr.io/cloud-builders/docker"
  args: [ "build" , "." , "--tag" , "gcr.io/heden-enterprises/he-nginx" ]

- id: publish
  name: "gcr.io/cloud-builders/docker"
  args: [ "push" , "gcr.io/heden-enterprises/he-nginx" ]

- id: deploy
  name: "gcr.io/cloud-builders/gcloud"
  entrypoint: "bash"
  args:
  - "-c"
  - |
    gcloud components install kubectl
    gcloud config set project heden-enterprises
    gcloud container clusters get-credentials web-cluster --zone us-central1-a
    kubectl get replicasets -l hedenenterprises.io/app=heden-enterprises-web | tail -1 | awk '{print $1}' > replicasets
    kubectl set image deployment/heden-enterprises-web heden-enterprises-web=gcr.io/heden-enterprises/he-nginx:latest
    kubectl delete replicasets/$(cat replicasets | tr -d "[:space:]")

# PROJECT_ID="heden-enterprises"
# PROJECT_NUMBER="$(gcloud projects describe $PROJECT_ID --format='get(projectNumber)')"
# gcloud projects add-iam-policy-binding $PROJECT_NUMBER --member=serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com --role=roles/container.developer
